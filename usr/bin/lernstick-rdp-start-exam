#!/bin/bash

# determine scaling
RDP_SCALE=100
PRIMARY_DISPLAY="$(xrandr | grep -w "connected primary")"
printf "primary display:\\n%s" "$PRIMARY_DISPLAY"
if [ -z "$PRIMARY_DISPLAY" ]
then
	echo "WARNINIG: primary display not found"
else
	MONITOR_WIDTH=$(echo "$PRIMARY_DISPLAY" | sed 's/.* \(.*\)mm x .*mm/\1/g')
	echo "monitor width: $MONITOR_WIDTH mm"
	if [ "$MONITOR_WIDTH" -eq 0 ]
	then
		# seen in VirtualBox
		echo "WARNINIG: unknown monitor width"
	else
		SCREEN_WIDTH=$(echo "$PRIMARY_DISPLAY" | sed 's/.* primary \(.*\)x.*+.*/\1/g')
		echo "screen width: $SCREEN_WIDTH pixel"
		DPI=$((SCREEN_WIDTH*254/MONITOR_WIDTH/10))
		echo "DPI: $DPI"
		SCALE=$(echo "scale=2; ${DPI}/96" | bc)
		echo "scaling factor ($DPI/96): $SCALE"
		if [ $(echo "($SCALE > 1.2) && ($SCALE <= 1.6)" | bc -l) -eq 1 ]
		then
			RDP_SCALE=140
		elif [ $(echo "$SCALE > 1.6" | bc -l) -eq 1 ]
		then
			RDP_SCALE=180
		fi
	fi
fi
echo "RDP_SCALE: $RDP_SCALE"

# gettext support
. gettext.sh
export TEXTDOMAIN=lernstick-rdp-start-exam

# check if config is available
CONFIG_ZIP="/home/user/Schreibtisch/exam.zip"
if [ ! -f $CONFIG_ZIP ]
then
zenity --error --no-wrap --text "$(gettext "The exam configuration was not found.\\n\\nPlease download the exam configuration\\nto your desktop.")"
	exit 1
fi

# extract config
TMP_DIR=$(mktemp -d)
unzip -d "$TMP_DIR" "$CONFIG_ZIP"

# parse config file
CONFIG=$(<"$TMP_DIR/exam.config")
declare -A EXAM_CONFIG
while IFS='=' read -r KEY VALUE
do
	EXAM_CONFIG["$KEY"]="$VALUE"
done <<< "$CONFIG"

# open firewall
sudo lernstick-rdp-open-firewall "$CONFIG" "$TMP_DIR/exam.config.sig"
EXIT_CODE=$?

# error handling
if [ $EXIT_CODE -eq 10 ]
then
	zenity --error --no-wrap --text "$(gettext "The signature of the exam configuration is invalid.")"
	exit 1

elif [ $EXIT_CODE -ne 0 ]
then
	zenity --error --no-wrap --text "$(gettext "Could not open firewall.")"
	exit 1
fi

# start RDP connection to exam server
xfreerdp \
	-wallpaper \
	/cert-ignore \
	/gdi:hw \
	/f \
	/scale:$RDP_SCALE \
	/u:"${EXAM_CONFIG[USER]}" \
	/p:"${EXAM_CONFIG[PASSWORD]}" \
	/v:"${EXAM_CONFIG[SERVER]}"
